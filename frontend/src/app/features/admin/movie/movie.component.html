<div class="min-h-screen bg-slate-50 py-10 px-4 sm:px-6 lg:px-8">
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8"
  >
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Quản Lý Phim</h1>
    </div>
    <button
      nz-button
      nzType="primary"
      nzSize="large"
      nzShape="circle"
      (click)="openMovieModal('add')"
    >
      <nz-icon nzType="plus" nzTheme="outline" />
    </button>
  </div>
  <div class="mb-5 flex items-center justify-between">
    <div class="relative">
      <nz-input-group nzPrefixIcon="search" class="rounded-xl max-w-lg">
        <input
          nz-input
          placeholder="Tìm kiếm"
          style="width: 500px"
          type="text"
          [formControl]="searchCtrl"
        />
      </nz-input-group>
      <!--   Search result list-->
      @if (searchResults() && searchResults().length > 0) {
        <div
          class="absolute z-50 top-full mt-1 w-full bg-white border rounded shadow max-h-72 overflow-y-auto"
        >
          <nz-list
            [nzDataSource]="searchResults()"
            [nzRenderItem]="item"
            [nzBordered]="true"
            class="max-h-52 overflow-y-auto"
          >
            <ng-template #item let-movie>
              <nz-list-item
                (click)="selectMovie(movie.id)"
                class="cursor-pointer transition p-2 rounded"
                [ngClass]="{
                  'bg-blue-100': selectedMovie()?.id === movie.id,
                  'hover:bg-gray-100': selectedMovie()?.id !== movie.id,
                }"
              >
                <nz-list-item-meta
                  [nzAvatar]="nzAvatar"
                  [nzTitle]="nzTitle"
                  [nzDescription]="nzDescription"
                >
                </nz-list-item-meta>

                <ng-template #nzAvatar>
                  <nz-avatar
                    nzShape="square"
                    [nzSize]="64"
                    [nzSrc]="movie.poster"
                  >
                  </nz-avatar>
                </ng-template>

                <ng-template #nzTitle>
                  <span class="font-semibold">{{ movie.title }}</span>
                </ng-template>

                <ng-template #nzDescription>
                  <span class="text-xs text-gray-500">
                    {{ movie.release_date | date: "yyyy" }} —
                    {{ movie.overview }}
                  </span>
                </ng-template>
              </nz-list-item>
            </ng-template>
          </nz-list>
        </div>
      }
    </div>
    <nz-select class="w-[150px]" nzPlaceHolder="Sắp xếp">
      <nz-option nzLabel="Mới nhất" nzValue="newest"></nz-option>
      <nz-option nzLabel="Cũ nhất" nzValue="oldest"></nz-option>
    </nz-select>
  </div>
  <nz-spin [nzSpinning]="loading$ | async">
    <div
      class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 overflow-hidden"
    >
      <nz-table
        [nzData]="movieList"
        nzShowPagination
        [nzFrontPagination]="false"
        [nzTotal]="pagination?.totalElements || 0"
        [nzPageIndex]="pageIndex"
        [nzPageSize]="pageSize"
        [nzShowSizeChanger]="true"
        (nzPageIndexChange)="onPageChange($event)"
        (nzPageSizeChange)="onSizeChange($event)"
      >
        <thead>
          <tr>
            @for (item of headerColumn; track item) {
              <th>
                {{ item }}
              </th>
            }
          </tr>
        </thead>
        <tbody>
          @for (item of movieList; track item.id) {
            <tr
              class="group hover:bg-gray-50 transition-colors border-b border-gray-100"
            >
              <td class="px-6 py-4">
                <img
                  class="w-14 h-20 rounded-lg object-cover bg-gray-200 shadow-sm"
                  [src]="item.poster"
                  [alt]="item.title"
                />
              </td>
              <td class="text-justify px-6 py-4">
                <div class="font-bold text-gray-900 text-base">
                  {{ item.title }}
                </div>
                <div class="text-sm text-gray-500">
                  {{ item.duration }} min &bull;
                  {{ item.releaseDate | date: "dd/MM/yyyy" }}
                </div>
              </td>
              <td>
                @for (g of item.genres; track g) {
                  <nz-tag>{{ g }}</nz-tag>
                }
              </td>
              <td class="text-center">
                @let tag = item.isDeleted | isDeleted;
                <nz-tag [nzColor]="tag.color">
                  {{ tag.label }}
                </nz-tag>
              </td>
              <td class="px-6 py-4 text-right">
                <div>
                  <nz-space>
                    <button
                      nz-button
                      nzType="text"
                      nzShape="circle"
                      (click)="openMovieModal('view', item.id)"
                    >
                      <nz-icon nzType="eye" nzTheme="twotone" />
                    </button>
                    <button
                      nz-button
                      nzType="text"
                      nzShape="circle"
                      (click)="openMovieModal('edit', item.id)"
                    >
                      <nz-icon
                        nzType="edit"
                        nzTheme="twotone"
                        nzTwotoneColor="#52c41a"
                      />
                    </button>
                    <button
                      nz-button
                      nzType="text"
                      nzShape="circle"
                      (click)="onDelete(item.id)"
                    >
                      <nz-icon
                        nzType="delete"
                        nzTheme="twotone"
                        nzTwotoneColor="#e7000b"
                      />
                    </button>
                  </nz-space>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </nz-table>
    </div>
  </nz-spin>
  @let error = error$ | async;
  @if (error) {
    <nz-alert nzType="error" [nzMessage]="error" nzShowIcon nzCloseable>
    </nz-alert>
  }
</div>
