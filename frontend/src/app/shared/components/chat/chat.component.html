@if (isOpen()) {
  <div
    class="fixed bottom-[90px] right-6 z-50 flex flex-col w-[360px] h-[520px] max-h-[80vh] bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden font-sans animate-fade-in-up"
  >
    <!-- HEADER -->
    <div
      class="flex h-16 shrink-0 items-center justify-between bg-blue-600 px-5 text-white shadow-md"
    >
      <div class="flex items-center gap-3">
        <div class="relative">
          <nz-avatar
            nzIcon="user"
            class="!bg-white !text-blue-600 shadow-sm"
            [nzSize]="36"
          ></nz-avatar>
          <span
            class="absolute bottom-0 right-0 h-2.5 w-2.5 rounded-full bg-green-400 ring-2 ring-white"
          ></span>
        </div>
        <div>
          <h3 class="text-[15px] font-bold text-white m-0">Support Bot</h3>
          <p class="text-[11px] text-blue-100 m-0">Luôn sẵn sàng</p>
        </div>
      </div>
      <button
        (click)="toggleChat()"
        class="text-white/80 hover:text-white hover:bg-white/20 h-10 w-10 p-2 rounded-full transition-colors cursor-pointer"
      >
        <nz-icon nzType="close" nzTheme="outline" />
      </button>
    </div>

    <!-- BODY -->
    <div class="flex-1 overflow-y-auto bg-slate-50 p-4 space-y-5" #scrollBottom>
      @for (msg of messages(); track msg.time) {
        <div
          class="flex w-full"
          [class.justify-end]="msg.sender === 'user'"
          [class.justify-start]="msg.sender === 'bot'"
        >
          <div
            class="flex max-w-[85%] gap-2"
            [class.flex-row-reverse]="msg.sender === 'user'"
          >
            <!-- Avatar Bot -->
            @if (msg.sender === "bot") {
              <nz-avatar
                nzIcon="robot"
                class="!bg-orange-500 mt-auto shrink-0 shadow-sm"
                [nzSize]="28"
              ></nz-avatar>
            }

            <!-- Bubble chat -->
            <div
              class="relative px-4 py-2.5 shadow-sm text-[14px] leading-relaxed transition-all"
              [class]="
                msg.sender === 'user'
                  ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none'
                  : 'bg-white text-gray-700 border border-gray-200 rounded-2xl rounded-tl-none'
              "
            >
              @if (msg.sender === "user") {
                {{ msg.content }}
              } @else {
                <markdown [data]="msg.content"></markdown>
              }

              <span
                class="block text-[10px] mt-1 opacity-70"
                [class]="
                  msg.sender === 'user'
                    ? 'text-blue-100 text-left'
                    : 'text-gray-400 text-right'
                "
              >
                {{ msg.time | date: "HH:mm" }}
              </span>
            </div>
          </div>
        </div>
      }
      @if (isTyping()) {
        <div class="flex w-full justify-start">
          <div class="flex gap-2">
            <nz-avatar
              nzIcon="robot"
              class="!bg-orange-500 mt-auto shrink-0 shadow-sm"
              [nzSize]="28"
            ></nz-avatar>
            <div
              class="bg-white border border-gray-200 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm flex items-center gap-1 h-10"
            >
              <div
                class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"
              ></div>
              <div
                class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"
              ></div>
              <div
                class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"
              ></div>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- FOOTER -->
    <div class="shrink-0 bg-white p-3 border-t border-gray-100">
      <div
        class="flex items-center gap-2 bg-gray-100 rounded-full border border-transparent focus-within:bg-white focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-100 transition-all"
      >
        <input
          type="text"
          [ngModel]="inputValue()"
          (ngModelChange)="inputValue.set($event)"
          (keyup.enter)="sendMessage()"
          placeholder="Nhập tin nhắn..."
          class="flex-1 bg-transparent border-none text-sm px-4 py-2 text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-0"
        />
        <button
          nz-button
          nzType="primary"
          nzShape="circle"
          (click)="sendMessage()"
          class="!bg-blue-600 !border-none hover:!bg-blue-700 shrink-0 shadow-md"
        >
          <nz-icon nzType="send" />
        </button>
      </div>
    </div>
  </div>
}

<nz-float-button
  [nzType]="'primary'"
  [nzIcon]="iconTemplate"
  (nzOnClick)="toggleChat()"
  [nzShape]="'circle'"
>
</nz-float-button>

<ng-template #iconTemplate>
  @if (isOpen()) {
    <nz-icon nzType="close" nzTheme="outline" />
  } @else {
    <nz-icon nzType="message" nzTheme="outline" />
  }
</ng-template>
